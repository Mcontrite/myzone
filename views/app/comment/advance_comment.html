{{ template "layout/header" .}}
{{/*<script src="//cdn.ckeditor.com/4.12.1/full/ckeditor.js"></script>*/}}
<script src="/static/ckeditor/ckeditor.js"></script>
<main id="body">
	<div class="container">
		<div class="row">
			<div class="col-lg-10 mx-auto">
				<div class="card">
					<div class="card-header"> 高级回复 </div>
					<div class="card-body">
						<form action="/api/saying/{{.saying_id}}/comment" method="post" id="advance_reply_form" class="d-block">
							<input type="hidden" id="quotetid" name="sayingid" value="{{.saying_id}}">
							<input type="hidden" id="docutype" name="docutype" value="0">
							<div class="message mt-1">
								<textarea class="form-control" id="editor1" placeholder="内容" name="message"></textarea>
							</div>
							<div class="text-muted mt-2 small">
								<div class="d-flex justify-content-between">
									<div>
										<button id="replysubmit" type="button" class="btn btn-sm btn-secondary" id="submit" data-loading-text="正在提交...">
											回复 </button>
									</div>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
			<a role="button" class="btn btn-secondary btn-block xn-back col-lg-6 mx-auto mb-3" href="javascript:history.back();">返回</a>
		</div>
	</div>
</main>
<script>
	CKEDITOR.replace('message', {
		language: 'zh-cn',
		disallowedContent: '<script >',
		// toolbar: [['Smiley']],
		// toolbarCanCollapse: true,
		toolbarStartupExpanded: false,
		toolbar: [{
			name: 'document',
			items: ['Source', '-', 'Preview']
		}, {
			name: 'clipboard',
			items: ['Cut', 'Copy', 'Paste', 'PasteText', '-', 'Undo', 'Redo']
		}, {
			name: 'basicstyles',
			items: ['Bold', 'Italic', 'Underline', 'RemoveFormat']
		}, {
			name: 'colors',
			items: ['TextColor']
		}, {
			name: 'paragraph',
			items: ['NumberedList', 'BulletedList', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock', '-']
		}, {
			name: 'links',
			items: ['Link', 'Unlink']
		}, {
			name: 'insert',
			items: ['Image', 'Smiley']
		}, '/', {
			name: 'styles',
			items: ['Styles', 'Format', 'Font', 'FontSize']
		}, {
			name: 'tools',
			items: ['Maximize', 'ShowBlocks']
		}, ],
		height: '25rem',
		resize_minHeight: '5rem',
		image_previewText: " ",
		upload_hidden: false,
		removeDialogTabs: 'image:advanced;image:Link',
		filebrowserImageUploadUrl: "/api/image/upload",
		filebrowserUploadUrl: "/api/image/upload",
		//enterMode:CKEDITOR.ENTER_BR, //屏蔽换行符<br>
		//shiftEnterMode:CKEDITOR.ENTER_P, //屏蔽段落<p>
		extraPlugins: 'uploadimage',
		// extraPlugins:['codesnippet','uploadimage'],
		codeSnippet_theme: 'zenburn'
	});
	var qrform = $("#advance_reply_form")
	var jsubmit = $('#replysubmit');
	var maxSize = 1 * 1024 * 1024
	qrform.on("keydown", function() {
		if (event.keyCode == 13) {
			return false;
		}
	})
	jsubmit.on('click', function() {
		if (CKEDITOR.instances.editor1.getData().length == 0) {
			$.alert("亲，写点什么再提交吧 ^_^")
			return;
		}
		qrform.reset();
		jsubmit.button('loading');
		var replydata = qrform.serializeObject();
		replydata.message = CKEDITOR.instances.editor1.getData();
		console.log(replydata)
		$.xpost(qrform.attr('action'), replydata, function(code, message) {
			console.log(code, ":", message)
			if (code == 200) {
				$.alert("回复成功")
				setTimeout(function() {
					// addNewReplyElement()
					history.back()
				}, 2000)
			} else if (code < 0) {
				$.alert(message);
				jsubmit.button('reset');
			} else {
				jform.find('[name="' + code + '"]').alert(message).focus();
				jsubmit.button('reset');
			}
		});
		return false;
	});

	function afterAddNewSaying() {
		var jsubmit = $('#replysubmit')
		jsubmit.button('reset');
	}

	function trimChar(str, char, type) {
		if (char) {
			if (type == 'left') {
				return str.replace(new RegExp('^\\' + char + '+', 'g'), '');
			} else if (type == 'right') {
				return str.replace(new RegExp('\\' + char + '+$', 'g'), '');
			}
			return str.replace(new RegExp('^\\' + char + '+|\\' + char + '+$', 'g'), '');
		}
		return str.replace(/^\s+|\s+$/g, '');
	}
</script>
{{ template "layout/footer" .}}
